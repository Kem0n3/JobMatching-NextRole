<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        :root {
            --color-primary: #2563eb; --color-primary-dark: #1d4ed8; --color-primary-light: #dbeafe;
            --color-text-strong: #111827; --color-text-base: #374151; --color-text-subtle: #6b7280;
            --color-text-on-primary: #ffffff; --color-bg-page: #f9fafb; --color-bg-content: #ffffff;
            --color-border: #e5e7eb; --font-family-main: 'Inter', sans-serif;
            --border-radius: 0.75rem; --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
    </style>
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/forms.css">
</head>
<body>
    <div class="app-shell">
        <aside class="sidebar-area">
            <%- include('../partials/sidebar') %>
        </aside>

        <div class="main-wrapper">
            <header class="navbar-area">
                <%- include('../partials/navbar') %>
            </header>

            <main class="main-content-area">
                <div class="page-header">
                    <h1><%= title %></h1>
                    <p>Fill in the details below to find the perfect candidate.</p>
                </div>

                <div class="form-container">
                    <% if (typeof errors !== 'undefined' && errors.length > 0) { %>
                        <div class="error-messages">
                            <ul>
                                <% errors.forEach(function(error) { %> <li><%= error.msg %></li> <% }); %>
                            </ul>
                        </div>
                    <% } %>

                    <form action="<%= isEditMode ? '/jobs/' + jobId : '/jobs' %>" method="POST">
                        <div class="form-section">
                            <h2>Job Details</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="jobTitle">Job Title</label>
                                    <input type="text" id="jobTitle" name="jobTitle" value="<%= (locals.jobData && locals.jobData.jobTitle) ? locals.jobData.jobTitle : '' %>" required>
                                </div>
                                <div class="form-group">
                                    <label for="companyName">Company Name</label>
                                    <input type="text" id="companyName" name="companyName" value="<%= (locals.jobData && locals.jobData.companyName) ? locals.jobData.companyName : '' %>" required>
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label for="jobDescription">Job Description</label>
                                <textarea id="jobDescription" name="jobDescription" rows="8" required><%= (locals.jobData && locals.jobData.jobDescription) ? locals.jobData.jobDescription : '' %></textarea>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="jobLocation">Job Location</label>
                                    <select id="jobLocation" name="jobLocation" class="select2-single" required>
                                        <option value="">-- Select Location --</option>
                                        <% locationsList.forEach(function(loc) { %>
                                            <option value="<%= loc.id %>" <%= (locals.jobData && locals.jobData.jobLocation === loc.id) ? 'selected' : '' %>><%= loc.text %></option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="jobType">Job Type</label>
                                    <select id="jobType" name="jobType" class="select2-single" required>
                                        <option value="">-- Select Job Type --</option>
                                        <% jobTypeList.forEach(function(type) { %>
                                            <option value="<%= type.id %>" <%= (locals.jobData && locals.jobData.jobType === type.id) ? 'selected' : '' %>><%= type.text %></option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="careerLevel">Career Level</label>
                                    <select id="careerLevel" name="careerLevel" class="select2-single" required>
                                        <option value="">-- Select Career Level --</option>
                                        <% careerLevelsList.forEach(function(level) { %>
                                            <option value="<%= level.id %>" <%= (locals.jobData && locals.jobData.careerLevel === level.id) ? 'selected' : '' %>><%= level.text %></option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="salaryRange">Salary Range (Optional)</label>
                                    <input type="text" id="salaryRange" name="salaryRange" value="<%= (locals.jobData && locals.jobData.salaryRange) ? locals.jobData.salaryRange : '' %>" placeholder="e.g., $70k - $90k Annually">
                                </div>
                            </div>
                             <div class="form-group checkbox-group full-width">
                                <input type="checkbox" id="allowsRemote" name="allowsRemote" value="true" <%= (locals.jobData && locals.jobData.allowsRemote) ? 'checked' : '' %>>
                                <label for="allowsRemote">This job can be performed remotely</label>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2>Requirements</h2>
                            <div class="form-group full-width">
                                <label for="requiredSkills">Required Skills</label>
                                <select id="requiredSkills" name="requiredSkills" multiple="multiple" class="select2-multiple">
                                    <% skillsList.forEach(function(skill) { %>
                                        <option value="<%= skill.id %>" <%= (locals.jobData && locals.jobData.requiredSkills && locals.jobData.requiredSkills.includes(skill.id)) ? 'selected' : '' %>><%= skill.text %></option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label for="preferredSkills">Preferred Skills (Optional)</label>
                                <select id="preferredSkills" name="preferredSkills" multiple="multiple" class="select2-multiple">
                                    <% skillsList.forEach(function(skill) { %>
                                        <option value="<%= skill.id %>" <%= (locals.jobData && locals.jobData.preferredSkills && locals.jobData.preferredSkills.includes(skill.id)) ? 'selected' : '' %>><%= skill.text %></option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="minimumDegreeLevel">Minimum Degree Level</label>
                                    <select id="minimumDegreeLevel" name="minimumDegreeLevel" class="select2-single" required>
                                        <option value="">-- Select Minimum Degree --</option>
                                        <% degreeLevelsList.forEach(function(degree) { %>
                                            <option value="<%= degree.id %>" <%= (locals.jobData && locals.jobData.minimumDegreeLevel === degree.id) ? 'selected' : '' %>><%= degree.text %></option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="preferredFieldOfStudy">Preferred Field of Study (Optional)</label>
                                    <select id="preferredFieldOfStudy" name="preferredFieldOfStudy" class="select2-single">
                                        <option value="">-- Select Preferred Field --</option>
                                        <% fieldsOfStudyList.forEach(function(field) { %>
                                            <option value="<%= field.id %>" <%= (locals.jobData && locals.jobData.preferredFieldOfStudy === field.id) ? 'selected' : '' %>><%= field.text %></option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2>Category Experience Requirements</h2>
                            <div id="experienceRequirementsContainer">
                                <% const experiences = (locals.jobData && locals.jobData.experienceRequirements && locals.jobData.experienceRequirements.length > 0) ? locals.jobData.experienceRequirements : [{}]; %>
                                <% experiences.forEach(function(exp, index) { %>
                                    <div class="dynamic-entry">
                                        <% if (experiences.length > 1 || (exp.category_id || exp.minYears)) { %>
                                            <button type="button" class="remove-btn remove-exp-req" title="Remove Requirement">Remove</button>
                                        <% } %>
                                        <div class="form-grid">
                                            <div class="form-group">
                                                <label for="exp_req_category_<%= index %>">Category</label>
                                                <select id="exp_req_category_<%= index %>" name="experienceRequirements[<%= index %>][category_id]" class="select2-single category-select">
                                                    <option value="">-- Select Category --</option>
                                                    <% broaderCategoriesList.forEach(function(cat) { %>
                                                        <option value="<%= cat.id %>" <%= (exp && exp.category_id === cat.id) ? 'selected' : '' %>><%= cat.text %></option>
                                                    <% }); %>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="exp_req_minYears_<%= index %>">Minimum Years</label>
                                                <input type="number" id="exp_req_minYears_<%= index %>" name="experienceRequirements[<%= index %>][minYears]" min="0" step="0.5" value="<%= (exp && exp.minYears !== undefined) ? exp.minYears : '' %>" placeholder="e.g., 2">
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                            <button type="button" id="addExperienceRequirementBtn" class="add-btn">Add Experience Requirement</button>
                        </div>

                        <% if (isEditMode) { %>
                            <div class="form-section">
                                <h2>Status</h2>
                                <div class="form-group checkbox-group full-width">
                                    <input type="checkbox" id="isActive" name="isActive" value="true" <%= (locals.jobData && locals.jobData.isActive) ? 'checked' : '' %>>
                                    <label for="isActive">Job Posting is Active</label>
                                </div>
                            </div>
                        <% } %>

                        <button type="submit" class="form-submit-button"><%= isEditMode ? 'Update Job Posting' : 'Post Job' %></button>
                    </form>
                </div>
            </main>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script src="/js/main.js"></script>
        <script>
            $(document).ready(function() {
                function initializeSelect2(selector) {
                    $(selector).select2({
                        placeholder: $(selector).find('option[value=""]').text() || "Select an option",
                        allowClear: true,
                        width: '100%'
                    });
                }
                $('.select2-multiple').select2({ placeholder: "Select options", allowClear: true, width: '100%' });
                $('.select2-single').each(function() { initializeSelect2(this); });

                function reindexExperienceRequirements() {
                    $('#experienceRequirementsContainer .dynamic-entry').each(function(index, entry) {
                        $(entry).find('select[name^="experienceRequirements"]').attr('name', `experienceRequirements[${index}][category_id]`).attr('id', `exp_req_category_${index}`);
                        $(entry).find('input[name^="experienceRequirements"]').attr('name', `experienceRequirements[${index}][minYears]`).attr('id', `exp_req_minYears_${index}`);
                        if ($('#experienceRequirementsContainer .dynamic-entry').length > 1) {
                           $(entry).find('.remove-exp-req').show();
                        } else {
                           const catVal = $(entry).find('select[name$="[category_id]"]').val();
                           const yearsVal = $(entry).find('input[name$="[minYears]"]').val();
                           if (catVal || yearsVal) { $(entry).find('.remove-exp-req').show(); }
                           else { $(entry).find('.remove-exp-req').hide(); }
                        }
                    });
                }

                $('#addExperienceRequirementBtn').on('click', function() {
                    const container = $('#experienceRequirementsContainer');
                    const entryCount = container.find('.dynamic-entry').length;
                    const newEntryHtml = `
                        <div class="dynamic-entry">
                            <button type="button" class="remove-btn remove-exp-req" title="Remove Requirement">Remove</button>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="exp_req_category_${entryCount}">Category</label>
                                    <select id="exp_req_category_${entryCount}" name="experienceRequirements[${entryCount}][category_id]" class="select2-single-new category-select" style="width: 100%;">
                                        <option value="">-- Select Category --</option>
                                        <% broaderCategoriesList.forEach(function(cat) { %>
                                            <option value="<%= cat.id %>"><%= cat.text %></option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="exp_req_minYears_${entryCount}">Minimum Years</label>
                                    <input type="number" id="exp_req_minYears_${entryCount}" name="experienceRequirements[${entryCount}][minYears]" min="0" step="0.5" placeholder="e.g., 2">
                                </div>
                            </div>
                        </div>`;
                    container.append(newEntryHtml);
                    initializeSelect2(`#exp_req_category_${entryCount}`);
                    reindexExperienceRequirements();
                });

                $('#experienceRequirementsContainer').on('click', '.remove-exp-req', function() {
                    $(this).closest('.dynamic-entry').remove();
                    reindexExperienceRequirements();
                });
                reindexExperienceRequirements();
            });
        </script>
    </body>
</html>